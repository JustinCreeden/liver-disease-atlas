---
title: "Precision and recall of chronic mouse models"
output: 
  workflowr::wflow_html:
    code_folding: hide
editor_options:
  chunk_output_type: console
---

```{r chunk-setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  autodep = TRUE,
  cache = TRUE,
  message = FALSE,
  warning = FALSE
)
```

```{r wall-time-start, cache=FALSE, include=FALSE}
# Track time spent on performing this analysis
start_time <- Sys.time()
```

## Introduction
Here we generate publication ready plots displaying various features of all included studies.

## Libraries and sources
These libraries and sources are used for this analysis.
```{r libs-and-src, message=FALSE, warning=FALSE, cache=FALSE}
library(tidyverse)
library(tidylog)
library(here)

library(AachenColorPalette)
library(UpSetR)
library(grid)
library(magick)
library(ComplexHeatmap)
library(lemon)
library(ggrepel)
library(patchwork)

source(here("code/utils-plots.R"))
```

Definition of global variables that are used throughout this analysis.
```{r analysis-specific-params, cache=FALSE}
# i/o
data_path <- "data/meta-mouse-vs-human"
output_path <- "output/meta-mouse-vs-human"

# graphical parameters
# fontsize
fz <- 7
```

## Number of DEGs
```{r number-degs}
df = readRDS(here(output_path, "chronic_mouse_deg_numbers.rds")) %>%
  mutate(regulation = fct_rev(str_to_title(regulation))) %>%
  mutate(study = case_when(
    str_detect(study, "_2m") ~ "CCl4 (2 Months)",
    str_detect(study, "_6m") ~ "CCl4 (6 Months)",
    str_detect(study, "_12m") ~ "CCl4 (12 Months)",
    TRUE ~ as.character(study)
  ))

mouse_deg_genes = df %>%
  ggplot(aes(y=fct_reorder(study, n, sum), x=n, fill=regulation)) +
  geom_col(position = "dodge") +
  labs(x="Number of differentially expressed genes", y="Chronic mouse model", 
       fill = "Regulation") +
   scale_x_log10(
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x))
 ) +
  annotation_logticks(sides = "b") +
  my_theme(grid = "x", fsize = fz) +
  scale_fill_manual(values = aachen_color(c("red75", "blue75")))
  
mouse_deg_genes
```

## Etiologies in numbers
```{r etiology-gene-numbers, eval=FALSE, include=FALSE}
df <- readRDS(here(output_path, "etiology_gene_sets.rds"))

mat_up <- df %>%
  filter(regulation == "up") %>%
  select(-regulation) %>%
  mutate(val = 1) %>%
  spread(etiology, val, fill = 0) %>%
  data.frame(row.names = 1)

pdf(file = "upset_plot1.pdf", width = 6, height = 4)
# grid.newpage()
upset(mat_up,
  nintersects = NA, mainbar.y.label = "Common genes",
  sets.x.label = "Total number of genes"
)
grid.text("Up", x = 0.65, y = 0.95, gp = gpar(fontsize = fz))
dev.off()

x = image_read_pdf("upset_plot1.pdf")
y = image_ggplot(x, interpolate = T)



yy = plot_grid(NULL, x$Main_bar, x$Sizes, x$Matrix, nrow = 2, align = "hv", rel_heights = c(3,1), rel_widths = c(1,3))

mat_down <- df %>%
  filter(regulation == "down") %>%
  select(-regulation) %>%
  mutate(val = 1) %>%
  spread(etiology, val, fill = 0) %>%
  data.frame(row.names = 1)

grid.newpage()
upset(mat_down,
  nintersects = NA, mainbar.y.label = "Common genes",
  sets.x.label = "Total number of genes"
)
grid.text("Down", x = 0.65, y = 0.95, gp = gpar(fontsize = fz))




m = make_comb_mat(mat_up)

ss = set_size(m)
cs = comb_size(m)
k = UpSet(m, 
	set_order = order(ss),
	comb_order = order(comb_degree(m), -cs),
	top_annotation = HeatmapAnnotation(
	  annotation_name_gp = gpar(fontsize = fz),
		"Common geneset" = anno_barplot(cs, 
            ylim = c(0, max(cs)*1.1),
			border = FALSE, 
			gp = gpar(fill = "black"), 
			height = unit(4, "cm"),
			axis_param = list(
				gp = gpar(fontsize = fz)
		)), 
		annotation_name_side = "left", 
		annotation_name_rot = 90,
		gp = gpar(fontsize = fz)),
	left_annotation = rowAnnotation(
	  annotation_name_gp = gpar(fontsize = fz),
		"Set size" = anno_barplot(-ss, 
			baseline = 0,
			axis_param = list(
				at = c(0, -500, -1000),
				labels = c(0, 500, 1000),
				labels_rot = 0,
				gp = gpar(fontsize = fz)),
			border = FALSE, 
			gp = gpar(fill = "black"), 
			width = unit(4, "cm")
		),
		set_name = anno_text(set_name(m), 
			location = 0.5, 
			just = "center",
			width = max_text_width(set_name(m)) + unit(1, "mm"),
			gp = gpar(fontsize = fz))
	), 
	right_annotation = NULL,
	show_row_names = FALSE)
```

## Precision and recall
```{r pr}
pr = readRDS(here(output_path, "precision_recall.rds")) %>%
  mutate(study = case_when(
    str_detect(study, "_2m") ~ "CCl4 (2 Months)",
    str_detect(study, "_6m") ~ "CCl4 (6 Months)",
    str_detect(study, "_12m") ~ "CCl4 (12 Months)",
    TRUE ~ as.character(study))) %>%
  mutate(regulation = fct_rev(str_to_title(regulation))) %>%
  mutate(label = case_when(
    study == "CCl4 (12 Months)" ~ study,
    TRUE ~NA_character_
  ))

pr_plot = pr %>%
  ggplot(aes(x=recall, y=precision, label = label, color = study)) +
  geom_point() +
  facet_rep_grid(etiology~regulation) +
  geom_abline(lty = "dashed") +
  expand_limits(x = 0, y = 0) +
  labs(x="Recall", y="Precision", color = "Mouse model") +
  my_theme(fsize = fz) +
  scale_color_viridis_d() +
  geom_label_repel(size = fz/(14/5), na.rm = T, show.legend = F)

pr_plot
```

## Collage
### Supplementary Figure 5.1
```{r s-fig-5-1}
sfig5_1 = mouse_deg_genes &
  theme(plot.tag = element_text(size = fz+3, face = "bold"),
        legend.key.height= unit(11.5, 'pt'),
        legend.key.width= unit(12.5, 'pt'))

sfig5_1

ggsave(here("figures/Supplementary Figure 5.1.pdf"), sfig5_1,
       width = 21, height = 8, units = c("cm"))
ggsave(here("figures/Supplementary Figure 5.1.png"), sfig5_1,
       width = 21, height = 8, units = c("cm"))
```

### Figure 5
```{r fig-5}
fig5 = NULL
ggsave(here("figures/Supplementary Figure 5.pdf"), fig5,
       width = 21, height = 29.7, units = c("cm"))
ggsave(here("figures/Supplementary Figure 5.png"), fig5,
       width = 21, height = 29.7, units = c("cm"))
```

```{r wall-time-end, cache=FALSE, include=FALSE}
duration <- abs(as.numeric(difftime(Sys.time(), start_time, units = "secs")))
t = print(sprintf("%02d:%02d", duration %% 3600 %/% 60,  duration %% 60 %/% 1))
```
Time spend to execute this analysis: `r t` minutes.
